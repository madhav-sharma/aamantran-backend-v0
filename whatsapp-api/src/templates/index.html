<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wedding RSVP Management</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .cc-usacan { background-color: lightblue; }
        .cc-uae { background-color: lightyellow; }
        .cc-uk { background-color: lightgreen; }
        .cc-in { background-color: orange; }
        .cc-other { background-color: lightgray; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f3f3f3; }
        .error { color: red; margin-bottom: 1em; }
        input[type="text"], input[type="checkbox"] { width: 100%; }
    </style>
</head>
<body>
    <h1>Wedding RSVP Guest List</h1>
    {% if errors and errors|length > 0 %}
        <div class="error">
            <ul>
            {% for err in errors %}
                <li>{{ err }}</li>
            {% endfor %}
            </ul>
        </div>
    {% endif %}
    <form method="post" action="/send-invites" style="margin-bottom: 1em;">
        <button type="submit">Send Invites</button>
    </form>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Greeting Name</th>
                <th>Phone</th>
                <th>Group ID</th>
                <th>Is Primary</th>
                <th>Ready</th>
                <th>Sent to WA</th>
                <th>Sent At</th>
                <th>Delivered At</th>
                <th>Read At</th>
                <th>Message ID</th>
            </tr>
        </thead>
        <tbody>
            {% for g in guests %}
            <tr>
                <td>{{ g.id }}</td>
                <td>{{ g.first_name }}</td>
                <td>{{ g.last_name }}</td>
                <td>{{ g.greeting_name or '' }}</td>
                <td class="{{ g.phone_class }} phone-cell" data-phone="{{ g.phone }}"></td>
                <td>{{ g.group_id }}</td>
                <td><input type="checkbox" {% if g.is_group_primary %}checked{% endif %} disabled></td>
                <td>
                    <form method="POST" action="/update-ready/{{ g.id }}" style="margin:0;display:inline;">
                        <input type="checkbox" name="ready" {% if g.ready %}checked{% endif %} onchange="this.form.submit()">
                    </form>
                </td>
                <td>{{ g.sent_to_whatsapp }}</td>
                <td>{{ g.sent_at if g.sent_at else 'N/A' }}</td>
                <td>{{ g.delivered_at if g.delivered_at else 'N/A' }}</td>
                <td>{{ g.read_at if g.read_at else 'N/A' }}</td>
                <td>{{ g.message_id or '' }}</td>
            </tr>
            {% endfor %}
            <tr>
                <form method="post" action="/add-guest">
                    <td></td>
                    <td><input name="first_name" type="text" required value=""></td>
                    <td><input name="last_name" type="text" required value=""></td>
                    <td><input name="greeting_name" type="text" value=""></td>
                    <td>
  <input type="text" id="phone-input" name="phone" value="" style="width: 130px;">
  <span id="phone-error"></span>
</td>
                    <td><input name="group_id" type="text" required value=""></td>
                    <td style="text-align:center"><input name="is_group_primary" type="checkbox" value="true" ></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><button type="submit">Add Guest</button></td>
                </form>
            </tr>
        </tbody>
    </table>
</body>
    <script>
      function debounce(func, delay) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func(...args), delay);
        };
      }
      // Format phone number for display (India & UAE)
      function formatPhoneForDisplay(value) {
        if (value.startsWith('+91') && value.length === 13) {
          return '+91-' + value.slice(3, 8) + '-' + value.slice(8);
        }
        if (value.startsWith('+971') && value.length === 13) {
          return '+971-' + value.slice(4, 6) + '-' + value.slice(6, 9) + '-' + value.slice(9);
        }
        return value;
      }

      // Validate phone number without altering the actual input value
      function validateAndFormatPhone(input) {
        let value = input.value.trim().replace(/[^+\d]/g, '');  // Strip non-digits except +
        const errorSpan = document.getElementById('phone-error');
        // Auto-format: Add '+' if missing and starts with digit
        if (value && !value.startsWith('+') && /^\d/.test(value)) {
          value = '+' + value;
        }
        // Restrict to India (+91, 10 digits) or UAE (+971, 9 digits)
        let isValid = false;
        let formatted = value;
        if (value.startsWith('+91') && value.length === 13) {  // +91 + 10 digits
          isValid = true;
          formatted = '+91-' + value.slice(3,8) + '-' + value.slice(8);  // e.g., +91-XXXXX-XXXXX
        } else if (value.startsWith('+971') && value.length === 13) {  // +971 + 9 digits
          isValid = true;
          formatted = '+971-' + value.slice(4,6) + '-' + value.slice(6,9) + '-' + value.slice(9);  // e.g., +971-XX-XXX-XXXX
        }
        if (value && !isValid) {
          input.style.border = '1px solid red';  // Error style
          errorSpan.textContent = 'Not a valid phone number (must be Indian +91 or UAE +971 in E.164 format)';
          errorSpan.style.color = 'red';
        } else {
          input.style.border = '';
          errorSpan.textContent = '';
          if (isValid) {
            // Do NOT alter the input value â€“ keep raw E.164 so backend validation works
            // Instead, you could show formatted preview if desired
          }
        }
      }
      // Apply formatting to existing phone cells once the DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.phone-cell').forEach(cell => {
          const raw = cell.dataset.phone;
          cell.textContent = formatPhoneForDisplay(raw);
        });
        const phoneInput = document.getElementById('phone-input');
        if (phoneInput) {
          const debouncedValidate = debounce(validateAndFormatPhone, 300);
          phoneInput.addEventListener('input', () => debouncedValidate(phoneInput));
        }
      });
    </script>


</html>