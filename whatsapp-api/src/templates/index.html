<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wedding RSVP Management</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .cc-usacan { background-color: lightblue; }
        .cc-uae { background-color: lightyellow; }
        .cc-uk { background-color: lightgreen; }
        .cc-in { background-color: orange; }
        .cc-other { background-color: lightgray; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f3f3f3; }
        .error { color: red; margin-bottom: 1em; }
        input[type="text"], input[type="checkbox"] { width: 100%; }
    </style>
</head>
<body>
    <h1>Wedding RSVP Guest List</h1>
    {% if errors and errors|length > 0 %}
        <div class="error">
            <ul>
            {% for err in errors %}
                <li>{{ err }}</li>
            {% endfor %}
            </ul>
        </div>
    {% endif %}
    <form method="post" action="/send-invites" style="margin-bottom: 1em;">
        <button type="submit">Send Invites</button>
    </form>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Greeting Name</th>
                <th>Phone</th>
                <th>Group ID</th>
                <th>Is Primary</th>
                <th>Ready</th>
                <th>Sent to WA</th>
                <th>Sent At</th>
                <th>Delivered At</th>
                <th>Read At</th>
                <th>Message ID</th>
            </tr>
        </thead>
        <tbody>
            {% for g in guests %}
            <tr>
                <td>{{ g.id }}</td>
                <td>{{ g.first_name }}</td>
                <td>{{ g.last_name }}</td>
                <td>{{ g.greeting_name or '' }}</td>
                <td class="{{ g.phone_class }}">{{ g.phone or '' }}</td>
                <td>{{ g.group_id }}</td>
                <td><input type="checkbox" {% if g.is_group_primary %}checked{% endif %} disabled></td>
                <td>
                    <form method="POST" action="/update-ready/{{ g.id }}" style="margin:0;display:inline;">
                        <input type="checkbox" name="ready" {% if g.ready %}checked{% endif %} onchange="this.form.submit()">
                    </form>
                </td>
                <td>{{ g.sent_to_whatsapp }}</td>
                <td>{{ g.sent_at if g.sent_at else 'N/A' }}</td>
                <td>{{ g.delivered_at if g.delivered_at else 'N/A' }}</td>
                <td>{{ g.read_at if g.read_at else 'N/A' }}</td>
                <td>{{ g.message_id or '' }}</td>
            </tr>
            {% endfor %}
            <tr>
                <form method="post" action="/add-guest">
                    <td></td>
                    <td><input name="first_name" type="text" required value="{{ form_data.first_name|e if form_data.first_name is defined else '' }}"></td>
                    <td><input name="last_name" type="text" required value="{{ form_data.last_name|e if form_data.last_name is defined else '' }}"></td>
                    <td><input name="greeting_name" type="text" value="{{ form_data.greeting_name|e if form_data.greeting_name is defined else '' }}"></td>
                    <td><input type="text" id="phone-input" name="phone" value="{{ form_data.phone if form_data else '' }}" style="width: 130px;"></td>
                    <td><input name="group_id" type="text" required value="{{ form_data.group_id|e if form_data.group_id is defined else '' }}"></td>
                    <td style="text-align:center"><input name="is_group_primary" type="checkbox" value="true" {% if form_data.is_group_primary %}checked{% endif %}></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><button type="submit">Add Guest</button></td>
                </form>
            </tr>
        </tbody>
    </table>
</body>
    <script>
      function debounce(func, delay) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func(...args), delay);
        };
      }
      function validateAndFormatPhone(input) {
        let value = input.value.trim();
        // Auto-format: Add '+' if missing and starts with digit
        if (value && !value.startsWith('+') && /^\d/.test(value)) {
          value = '+' + value;
          input.value = value;
        }
        // Validate
        const regex = /^\+[1-9]\d{1,14}$/;
        if (value && !regex.test(value)) {
          input.style.border = '1px solid red';
        } else {
          input.style.border = '';
        }
      }
      document.addEventListener('DOMContentLoaded', function() {
        const phoneInput = document.getElementById('phone-input');
        if (phoneInput) {
          const debouncedValidate = debounce(validateAndFormatPhone, 300);
          phoneInput.addEventListener('input', () => debouncedValidate(phoneInput));
        }
      });
    </script>
</html>